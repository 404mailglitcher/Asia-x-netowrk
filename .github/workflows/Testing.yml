name: üõ†Ô∏è Temporary Ubuntu VPS with Ngrok (PASSWORD AUTH)

on:
  workflow_dispatch:
    inputs:
      vps_password:
        description: 'Set a STRONG Password for the runner user'
        required: true
        default: 'P@sswOrd1234' # CHANGE THIS DEFAULT IMMEDIATELY!
      duration:
        description: 'Tunnel duration (max 6h - e.g., 6h, 3h30m, 1h)'
        required: false
        default: '6h'

jobs:
  temporary-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ‚öôÔ∏è System Setup, Update, and Install SSH Server
        run: |
          echo "--- Starting System Setup and SSH Installation ---"
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y openssh-server
          
      - name: üîê Configure Password Authentication
        id: password_setup
        run: |
          # The runner user is the default user in the GitHub runner environment
          USER_NAME="runner"
          PASSWORD="${{ github.event.inputs.vps_password }}"
          
          echo "Setting password for user: $USER_NAME"
          # Set the password for the runner user
          echo "$USER_NAME:$PASSWORD" | sudo chpasswd
          
          # Enable password authentication in the SSH config
          sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # Disable required key authentication to allow password login
          sudo sed -i 's/^PubkeyAuthentication yes/PubkeyAuthentication no/' /etc/ssh/sshd_config
          
          # Restart SSH service to apply changes
          sudo service ssh restart
          
          echo "SSH Server is now configured for Password Authentication."

      - name: üì¶ Install Useful Tools and Check Python
        run: |
          python3 --version
          sudo apt-get install -y htop neofetch tmux
          neofetch
      
      - name: üîí Start ngrok Tunnel (Expose SSH Port 22)
        id: ngrok_tunnel
        uses: tmshkr/ngrok-ssh@latest
        with:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
          SSH_PORT: 22 
          # We don't need any key inputs, we just need to expose the port.
          # USE_GITHUB_ACTOR_KEY is false by default, so it won't interfere.
          
      - name: üìù Display Full Connection Details
        run: |
          NGROK_URL="${{ steps.ngrok_tunnel.outputs.NGROK_HOST }}"
          NGROK_HOST=$(echo $NGROK_URL | awk -F'[:/]' '{print $4}')
          NGROK_PORT=$(echo $NGROK_URL | awk -F'[:/]' '{print $5}')
          
          echo "=========================================================="
          echo "          üö® NGROK VPS CONNECTION DETAILS (PASSWORD AUTH) üö®"
          echo "=========================================================="
          echo "‚úÖ SSH User: runner"
          echo "‚úÖ SSH Password: ${{ github.event.inputs.vps_password }}"
          echo "‚úÖ Ngrok IP/Port: $NGROK_HOST:$NGROK_PORT"
          echo ""
          echo "‚û°Ô∏è  FULL SSH CONNECTION COMMAND (Use Locally):"
          echo "      ssh -p $NGROK_PORT runner@$NGROK_HOST"
          echo "=========================================================="
