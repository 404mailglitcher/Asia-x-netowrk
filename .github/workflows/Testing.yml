name: üõ†Ô∏è Temporary Ubuntu VPS with Ngrok (PASSWORD AUTH - FINAL FIX)

on:
  workflow_dispatch:
    inputs:
      vps_password:
        description: 'Set a STRONG Password for the runner user (runner)'
        required: true
        default: 'P@sswOrd1234' # MUST BE CHANGED!
      duration:
        description: 'Tunnel duration (max 6h - e.g., 6h, 3h30m, 1h)'
        required: false
        default: '6h'

jobs:
  temporary-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours maximum

    steps:
      - name: ‚öôÔ∏è System Update and SSH Server Installation
        run: |
          echo "--- Starting System Setup and OpenSSH Installation ---"
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y openssh-server
          
      - name: üì¶ Install Useful Tools and Check Python
        run: |
          python3 --version
          sudo apt-get install -y htop neofetch tmux
          neofetch
          
      - name: üîê Configure User and Password Authentication
        run: |
          USER_NAME="runner"
          PASSWORD="${{ github.event.inputs.vps_password }}"
          
          # 1. Set the password for the default 'runner' user
          echo "$USER_NAME:$PASSWORD" | sudo chpasswd
          
          # 2. Enable Password Authentication in SSH config
          sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # 3. Disable Public Key Authentication to prioritize password login
          sudo sed -i 's/^PubkeyAuthentication yes/PubkeyAuthentication no/' /etc/ssh/sshd_config
          
          # 4. Ensure SSH is using port 22
          sudo sed -i 's/^#Port 22/Port 22/' /etc/ssh/sshd_config
          
          # 5. Restart the SSH service to apply changes
          sudo service ssh restart
          
          echo "SSH Server configured for Password Authentication on port 22."

      - name: üîí Start ngrok TCP Tunnel
        id: ngrok_tunnel
        # Using a reliable ngrok tunnel action for generic TCP exposure
        uses: lreimer/action-ngrok-connect@main
        with:
          # Your ngrok Authtoken from repository secrets
          ngrok_auth_token: ${{ secrets.NGROK_AUTHTOKEN }}
          # The local port to tunnel (OpenSSH default)
          local_port: 22
          # Use the job timeout to control the tunnel duration
          max_timeout: ${{ github.event.inputs.duration }}
          # Ensure ngrok uses TCP protocol
          protocol: tcp

      - name: üìù Display Full Connection Details
        run: |
          NGROK_HOST="${{ steps.ngrok_tunnel.outputs.ngrok_host }}"
          NGROK_PORT="${{ steps.ngrok_tunnel.outputs.ngrok_port }}"
          PASSWORD="${{ github.event.inputs.vps_password }}"

          echo "=========================================================="
          echo "          üö® NGROK VPS CONNECTION DETAILS üö®"
          echo "=========================================================="
          echo "‚úÖ SSH User: runner"
          echo "‚úÖ SSH Password: $PASSWORD"
          echo "‚úÖ Ngrok IP/Port: $NGROK_HOST:$NGROK_PORT"
          echo ""
          echo "‚û°Ô∏è  FULL SSH CONNECTION COMMAND (Use Locally):"
          echo "      ssh -p $NGROK_PORT runner@$NGROK_HOST"
          echo "=========================================================="
