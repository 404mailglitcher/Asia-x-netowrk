name: 6hr Temporary NGROK Ubuntu VPS

on:
  # Allows manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      username:
        description: 'SSH Username'
        required: true
        default: 'vpsuser'
      password:
        description: 'SSH Password'
        required: true
        type: string # Use string type for security/obscurity in UI

env:
  # Load NGROK token from repository secrets
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  provision-vps:
    runs-on: ubuntu-latest
    # Enforces the 6-hour runtime limit (360 minutes)
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- System Setup ---

      - name: System Update & Upgrade (Essential for security and new packages)
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y
          sudo apt-get dist-upgrade -y

      - name: Install Python & Development Tools (Includes Docker, Git, SSH Server, etc.)
        run: |
          # Install core tools and Python environment
          sudo apt-get install -y \
            python3 python3-pip python3-venv python3-dev \
            git curl wget nano vim htop net-tools build-essential \
            openssh-server openssh-client unzip zip jq tmux screen \
            docker.io docker-compose \
            nodejs npm

      - name: Upgrade pip & Install Common Python Packages (For immediate development)
        run: |
          # Upgrade pip and install common libraries
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install \
            requests flask django fastapi uvicorn \
            numpy pandas matplotlib jupyter \
            pytest black pylint
      
      # --- User and Authentication Setup ---

      - name: Create SSH User with Password and Add to Sudoers
        # Use || true to ignore "user already exists" on re-run attempts
        run: |
          sudo useradd -m -s /bin/bash ${{ github.event.inputs.username }} || true
          # Securely set the password
          echo "${{ github.event.inputs.username }}:${{ github.event.inputs.password }}" | sudo chpasswd
          # Grant sudo privileges
          sudo usermod -aG sudo ${{ github.event.inputs.username }}
          
          # Setup SSH directory structure (optional but good practice)
          sudo mkdir -p /home/${{ github.event.inputs.username }}/.ssh
          sudo chmod 700 /home/${{ github.event.inputs.username }}/.ssh
          sudo chown -R ${{ github.event.inputs.username }}:${{ github.event.inputs.username }} /home/${{ github.event.inputs.username }}

      - name: Configure SSH for Password Authentication
        run: |
          # Enable password authentication in SSH daemon config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config || true # Catch if no/commented
          # Disable root login
          sudo sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config || true
          sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config || true
          
          # Restart and enable SSH service
          sudo systemctl restart ssh
          sudo systemctl enable ssh

      # --- NGROK Setup and Tunneling ---

      - name: Download & Setup NGROK
        run: |
          cd /tmp
          # Download NGROK stable v3 for Linux AMD64
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
          unzip -q ngrok-v3-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin/
          sudo chmod +x /usr/local/bin/ngrok
          # Authenticate NGROK using the secret token
          ngrok config add-authtoken $NGROK_AUTHTOKEN

      - name: Start SSH & NGROK Tunnel and Extract Details
        id: ngrok_start
        run: |
          # Start SSH service (already done, but as a safeguard)
          sudo systemctl start ssh
          # Start NGROK tunnel in the background, forwarding port 22 (SSH)
          ngrok tcp 22 --log=stdout > /tmp/ngrok.log &
          sleep 10 # Give NGROK time to establish the tunnel
          
          # Extract public URL via NGROK's local API
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          # Extract Host and Port from the URL (e.g., tcp://2.tcp.ngrok.io:12345)
          SSH_HOST=$(echo $NGROK_URL | cut -d'/' -f3 | cut -d':' -f1)
          SSH_PORT=$(echo $NGROK_URL | cut -d':' -f3)
          
          # Set environment variables for the next step's output
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "SSH_HOST=$SSH_HOST" >> $GITHUB_ENV
          echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV

      - name: Display Connection Details
        run: |
          echo "=========================================="
          echo "üöÄ VPS IS READY - CONNECTION DETAILS"
          echo "=========================================="
          echo "SSH Command:"
          echo "ssh -p $SSH_PORT ${{ github.event.inputs.username }}@$SSH_HOST"
          echo ""
          echo "Username: ${{ github.event.inputs.username }}"
          echo "Password: ${{ github.event.inputs.password }}"
          echo ""
          echo "Full NGROK URL: $NGROK_URL"
          echo "=========================================="
          echo "‚è±Ô∏è  Server will run for 6 hours (360 minutes)"
          echo "=========================================="

      # --- Keep Alive ---

      - name: Keep Server Running (Sleep for 6 hours = 21600 seconds)
        run: |
          sleep 21600
