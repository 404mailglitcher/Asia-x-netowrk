name: üõ†Ô∏è Temporary Ubuntu VPS with Ngrok SSH

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      duration:
        description: 'Tunnel duration (max 6h - e.g., 6h, 3h30m, 1h)'
        required: false
        default: '6h'

jobs:
  temporary-vps:
    # Use the latest Ubuntu runner
    runs-on: ubuntu-latest
    
    # Set the maximum timeout for the job to 6 hours (the max allowed)
    timeout-minutes: 360

    steps:
      - name: ‚öôÔ∏è System Setup and Update
        run: |
          echo "### Starting System Setup (Fully Updated) ###"
          sudo apt-get update
          sudo apt-get upgrade -y
          
      - name: üì¶ Install Useful Tools (Python is already pre-installed)
        run: |
          # The GitHub runner comes with Python 3, pip, git, etc., pre-installed.
          echo "Python 3 version:"
          python3 --version
          
          echo "Installing additional tools: htop, neofetch, tmux"
          sudo apt-get install -y htop neofetch tmux
          neofetch
      
      - name: üîë Generate SSH Keys and Setup Authentication
        id: ssh_key_setup
        run: |
          # 1. Generate a temporary, dedicated key pair for this session
          ssh-keygen -t rsa -b 4096 -f runner_ssh_key -N "" -C "github-ngrok-vps-key"
          
          # 2. Add the public key to authorized_keys for the 'runner' user
          mkdir -p ~/.ssh
          cat runner_ssh_key.pub >> ~/.ssh/authorized_keys
          
          # 3. Output the Private Key (for immediate connection)
          # Note: This is necessary to display in the logs for connection,
          # but should be treated as highly sensitive and deleted after the session.
          echo "--- PRIVATE KEY for this Session (Copy this ENTIRE block) ---"
          cat runner_ssh_key
          echo "--- END PRIVATE KEY ---"
          
          # 4. Save the private key content as an output for the ngrok action
          # This is needed because the ngrok action requires the key to start the tunnel.
          PRIVATE_KEY_CONTENT=$(cat runner_ssh_key | sed 's/$/%0A/' | tr -d '\n')
          echo "private_key=$PRIVATE_KEY_CONTENT" >> $GITHUB_OUTPUT
          
      - name: üîí Start ngrok SSH Tunnel
        id: ngrok_tunnel
        uses: tmshkr/ngrok-ssh@latest
        with:
          # Your ngrok Authtoken from repository secrets
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
          PORT: 22 # Default SSH port
          TIMEOUT: ${{ github.event.inputs.duration }}
          USERNAME: 'runner' # The default user on GitHub-hosted runners
          # Pass the generated private key content
          PRIVATE_KEY: ${{ steps.ssh_key_setup.outputs.private_key }}
          
      - name: üìù Display Full Connection Details
        run: |
          echo "=========================================================="
          echo "          üö® NGROK VPS CONNECTION DETAILS üö®"
          echo "=========================================================="
          
          # Ngrok provides the full URL/port as an output
          NGROK_URL="${{ steps.ngrok_tunnel.outputs.NGROK_HOST }}"
          
          if [ -z "$NGROK_URL" ]; then
             echo "ERROR: Ngrok URL could not be retrieved. Check your NGROK_AUTHTOKEN secret."
             exit 1
          fi
          
          # Extract hostname and port
          NGROK_HOST=$(echo $NGROK_URL | awk -F'[:/]' '{print $4}')
          NGROK_PORT=$(echo $NGROK_URL | awk -F'[:/]' '{print $5}')
          
          echo "‚úÖ SSH User: runner"
          echo "‚úÖ SSH Password: (None - uses Key Authentication)"
          echo "‚úÖ Ngrok IP/Port: $NGROK_HOST:$NGROK_PORT"
          echo ""
          echo "‚û°Ô∏è  FULL SSH CONNECTION COMMAND (Use Locally):"
          echo ""
          echo "   1. Save the private key (output above) to a local file, e.g., ngrok_key.pem"
          echo "   2. Set permissions: chmod 600 ngrok_key.pem"
          echo "   3. Run the command:"
          echo "      ssh -i ngrok_key.pem -p $NGROK_PORT runner@$NGROK_HOST"
          echo ""
          echo "=========================================================="
          echo "### The workflow is now running and will be active for ${{ github.event.inputs.duration }} (Max 6 hours). ###"
          echo "### DO NOT STOP THIS JOB if you want the tunnel to remain open! ###"
          echo "=========================================================="
